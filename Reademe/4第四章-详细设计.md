# 第四章 详细设计

​	本章在概要设计的基础上，进一步完善系统的各个功能与模块，主要包括多业务流程的设计、算法设计和数据库表的设计。本章重点介绍各个业务的程序设计逻辑，并依据第三章中的E-R图对数据库表进行设计，完成数据库表创建。

## 4.1程序流程设计

​	自助洗衣系统包含用户和管理员两套客户端，本小节将介绍用户开始洗衣的整套业务逻辑以及管理员管理设备、用户、订单的程序流程设计。

### 4.1.1 用户洗衣程序设计

​	用户在产生洗衣需求后会寻找设备，当用户发现设备后，可以扫描设备二维码，创建订单，使设备运行。系统会为用户生成订单、改变设备运行设备状态。用户洗衣程序流程图如图4-1所示。

​                      -----------------------------------------------------------

### 4.1.2 二维码生成程序设计

​	每个设备都有一个属于自己的唯一标识，这个标识使用雪花算法生成，雪花算法是 Twitter 开源的分布式 id 生成算法。其核心思想就是：使用一个 64 bit 的 long 型的数字作为全局唯一 id。在分布式系统中的应用十分广泛，且ID 引入了时间戳，基本上保持自增的。这样做的好处是避免删除数据后主键错位。

​	管理员会位每台设备生成一个二维码，这个二位码中存储了这台设备的唯一标识，二维码生成程序流程图如图4-2所示。

​                      -----------------------------------------------------------

### 4.1.3 令牌生成、分发、校验程序设计

​	令牌是整个系统全的核心，它就像是一个人的身份证一样，令牌就是一个无序字符串，这串字符串中包含了加密过的用户信息。本系统的令牌遵循了Oauth2.0协议，使用协议默认方法生成令牌，令牌一部分分发给用户，另一部分存储在系统缓存中，二者可以保证系统安全。

​	为保证用回账户安全，用户不应公开自己的令牌，令牌生成、分发程序设计流程图如图4-3所示。

​                      -----------------------------------------------------------

​	令牌校验程序设计流程图如图4-4所示。

​                      -----------------------------------------------------------

## 4.2数据库逻辑结构设计

​	本系统的数据库设计遵循第一范式与第二范式要求，尽量保持表与表之间的耦合性减小，由于物理外键会导致数据迁移变得极其困难，系统不使用物理外键。由于微服务架构的特殊性，每个服务都会使用自己的库，系统整体使用了3个库，反别是设备信息库、用户信息库和订单信息库。总共设计了6张表，分别是订单信息表、用户表、二维码表、设备信息表、设备状态表与服务表。

​	其中订单信息表、用户表、设备信息表、设备状态表与服务表是由E-R图的实体得来的；二维码表是专门用来存储二进制图片流的表，系统数据库表一览如表4-1所示。

*表4-1 系统数据库表一览*

| 数据表         | 功能       | 备注                               |
| -------------- | ---------- | ---------------------------------- |
| awmorder       | 订单信息表 | 存放订单信息                       |
| awmuser        | 用户表     | 存放用户信息                       |
| awmqrcode      | 二维码表   | 存放设备二进制二维码图片流         |
| servercontext  | 服务表     | 存放不同型号可提供的不同的服务信息 |
| washingmachine | 设备信息表 | 存放设备基本信息                   |
| washingserver  | 设备状态表 | 存放设备状态信息                   |

​	订单信息表存放订单信息，属性包括订单编号，用户ID，设备唯一标识，服务等级，订单开始时间，订单状态，同时依照阿里巴巴开发手册创建了本条数据的创建时间、更新时间、伪删除标记位以及微服务架构下保证并发情况的乐观锁。该表的逻辑结构如表4-2所示。

*表4-2 订单信息表*

| 字段        | 数据类型 | 能否为空 | 备注                         |
| ----------- | -------- | -------- | ---------------------------- |
| order_id    | varchar  | 否       | 订单唯一id                   |
| customer_id | varchar  | 否       | 顾客id                       |
| machine_id  | varchar  | 否       | 设备id                       |
| serverlevel | varchar  | 否       | 服务等级                     |
| start_time  | datetime | 否       | 开始洗衣时间                 |
| create_time | datetime | 否       | 订单创建时间                 |
| delflag     | varchar  | 否       | 伪删除标记                   |
| version     | int      | 否       | 乐观锁                       |
| update_time | datetime | 是       | 更新时间                     |
| order_state | varchar  | 否       | 订单当前状态，默认0，1运行中 |

​	用户表存放用户信息，属性包括用户ID、用户昵称、用户名、密码、用户支付密码，同时依照阿里巴巴开发手册创建了本条数据的创建时间、更新时间、伪删除标记位以及微服务架构下保证并发情况的乐观锁。该表的逻辑结构如表4-3所示。

*表4-3 用户表*

| 字段        | 数据类型 | 能否为空 | 备注                 |
| ----------- | -------- | -------- | -------------------- |
| awmuser_id  | varchar  | 否       | 用户唯一身份标识     |
| awmname     | varchar  | 否       | 昵称                 |
| awmusername | varchar  | 否       | 用户登陆系统账号     |
| password    | varchar  | 否       | 登陆系统密码（加密） |
| create_time | datetime | 否       | 创建时间             |
| update_time | datetime | 是       | 更新时间             |
| delflag     | varchar  | 否       | 伪删除标记位         |
| version     | int      | 否       | 乐观锁               |
| paypwd      | varchar  | 否       | 支付密码             |

​	二维码表存放设备二进制二维码图片流，属性包括二维码唯一标识、机器的唯一标识、二维码图片流，同时依照阿里巴巴开发手册创建了本条数据的创建时间、更新时间、伪删除标记位以及微服务架构下保证并发情况的乐观锁。该表的逻辑结构如表4-4所示。

*表4-4 二维码表*

| 字段        | 数据类型 | 能否为空 | 备注                      |
| ----------- | -------- | -------- | ------------------------- |
| qr_id       | varchar  | 否       | 二维码唯一标识            |
| machine_id  | varchar  | 否       | 机器的唯一标识            |
| qrcode      | blob     | 否       | 二维码图片流              |
| create_time | datetime | 否       | 创建日期                  |
| update_time | datetime | 是       | 更新日期                  |
| delflag     | varchar  | 否       | 伪删除标记，默认显示，为0 |
| version     | int      | 否       | 乐观锁                    |

​	服务表存放服务信息，属性包括服务唯一标识、服务类型、服务级别、服务金额，同时依照阿里巴巴开发手册创建了本条数据的创建时间、更新时间、伪删除标记位以及微服务架构下保证并发情况的乐观锁。该表的逻辑结构如表4-5所示。

*表4-5 服务表*

| 字段        | 数据类型 | 能否为空 | 备注         |
| ----------- | -------- | -------- | ------------ |
| sc_id       | varchar  | 否       | 服务唯一标识 |
| servertype  | varchar  | 否       | 服务唯一标识 |
| serverlevel | varchar  | 否       | 服务级别     |
| cost        | decimal  | 否       | 服务金额     |
| create_time | datetime | 否       | 创建日期     |
| update_time | datetime | 是       | 更新日期     |
| delflag     | varchar  | 否       | 伪删除标记   |
| version     | int      | 否       | 乐观锁       |

​	设备信息表存放设备信息，属性包括机器的唯一标识、品牌、型号、洗衣机类别、经度、纬度，同时依照阿里巴巴开发手册创建了本条数据的创建时间、更新时间、伪删除标记位以及微服务架构下保证并发情况的乐观锁。该表的逻辑结构如表4-6所示。

*表4-6 设备信息表*

| 字段        | 数据类型 | 能否为空 | 备注                      |
| ----------- | -------- | -------- | ------------------------- |
| machine_id  | varchar  | 否       | 机器的唯一标识            |
| brand       | varchar  | 否       | 品牌                      |
| model       | varchar  | 否       | 型号                      |
| type        | varchar  | 否       | 洗衣机类别                |
| create_time | datetime | 否       | 入库日期                  |
| update_time | datetime | 是       | 更新日期                  |
| delflag     | varchar  | 否       | 伪删除标记，默认显示，为0 |
| version     | int      | 否       | 乐观锁                    |
| longitude   | decimal  | 是       | 经度                      |
| latitude    | decimal  | 是       | 纬度                      |

​	设备状态表存放状态信息，属性包括机器服务唯一标识、机器的唯一标识、机器当前的状态、可提供的服务，同时依照阿里巴巴开发手册创建了本条数据的创建时间、更新时间、伪删除标记位以及微服务架构下保证并发情况的乐观锁。该表的逻辑结构如表4-7所示。

*表4-7 设备状态表*

| 字段             | 数据类型 | 能否为空 | 备注                                 |
| ---------------- | -------- | -------- | ------------------------------------ |
| machineserver_id | varchar  | 否       | 机器服务唯一标识                     |
| machine_id       | varchar  | 否       | 机器的唯一标识                       |
| state            | varchar  | 否       | 机器当前的状态,0:可用,1:占用,2:维护  |
| server           | varchar  | 否       | 可提供的服务(按照洗衣机的型号与类型) |
| create_time      | datetime | 否       | 创建时间                             |
| update_time      | datetime | 是       | 更新日期                             |
| delflag          | varchar  | 否       | 伪删除标记                           |
| version          | int      | 否       | 乐观锁                               |

## 4.3本章小结

​	本章对系统的业务流程以及数据库进行了一个详细设计，首先介绍了系统核心业务流程设计，利用流程图详细展示了几种业务逻辑，然后在第三章数据库概要设计基础上对数据库表进行详细设计，表的设计符合数据安全性、完整性的要求，并满足第一、第二范式。